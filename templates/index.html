<!DOCTYPE html>
<html>
<head>
<title>THKBot168 Dashboard</title>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='icons8-lion-head-64.png') }}">
<style>
/* กล่อง Approved/Cancelled Orders ให้กว้างเท่า wallet deposit */
#approved-section, #cancelled-section {
  max-width: 700px;
  margin: 0 auto 24px auto;
  float: none;
  display: block;
  text-align: center;
}
/* จัดกล่องรายการฝากวอเลท (Wallet Deposits) ให้อยู่ตรงกลาง */
#wallet-deposit-section {
  max-width: 700px;
  margin: 0 auto 24px auto;
  float: none;
}
/* ลดขนาดความกว้างกล่อง SCB/Kbiz ลง 1 เท่า */
.scb-account-box {
  max-width: 510px !important;
  min-width: 360px;
  width: 100%;
  flex: none !important;
}
.scb-account-box .scroll-box {
  max-width: 480px;
}
/* บังคับตารางในกล่อง SCB/Kbiz ใช้ table-layout: fixed เพื่อให้ max-width มีผลจริง */
.scb-account-box .scroll-box table {
  table-layout: fixed;
  width: 100%;
}
/* จำกัดความกว้างคอลัมน์ในกล่อง SCB ทั้ง 3 กล่อง ไม่ให้ล้น */
.scb-account-box .scroll-box th:nth-child(1),
.scb-account-box .scroll-box td:nth-child(1) {
  max-width: 90px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.scb-account-box .scroll-box th:nth-child(2),
.scb-account-box .scroll-box td:nth-child(2) {
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.scb-account-box .scroll-box th:nth-child(3),
.scb-account-box .scroll-box td:nth-child(3) {
  max-width: 110px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
/* สำหรับตาราง OTP SCB กฤษฏา (4 คอลัมน์) */
#scb3-sms-table th:nth-child(1), #scb3-sms-table td:nth-child(1) {
  max-width: 90px;
  font-size: 0.8em;
  white-space: nowrap;
  overflow: visible;
  text-overflow: clip;
}
#scb3-sms-table th:nth-child(2), #scb3-sms-table td:nth-child(2) {
  max-width: 80px;
  font-weight: bold;
  color: #e74c3c;
}
#scb3-sms-table th:nth-child(3), #scb3-sms-table td:nth-child(3) {
  max-width: 120px;
}
#scb3-sms-table th:nth-child(4), #scb3-sms-table td:nth-child(4) {
  max-width: 80px;
  font-weight: bold;
  color: #27ae60;
}
.header-logos img:first-child {
  height: 216px;
}
/* โลโก้หัวเว็บ */
/* โลโก้หัวเว็บ (ขนาดใหญ่ 3 เท่าและอยู่กลาง) */
.header-logos {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 48px;
  margin-bottom: 16px;
  margin-top: 16px;
}
.header-logos img {
  height: 144px;
  width: auto;
  object-fit: contain;
  background: transparent !important;
  border-radius: 12px;
  box-shadow: none;
}
.header-logos .sk-logo {
/* ปุ่ม toggle ยกเลิกแล้ว (แดง) - อยู่ใน <style> */
.toggle-cancelled {
  background: linear-gradient(90deg, #e74c3c 60%, #ff7675 100%) !important;
  color: #fff;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  font-size: 1.08em;
  padding: 10px 28px;
  margin: 18px 10px 24px 0;
  box-shadow: 0 2px 8px rgba(231,76,60,0.10);
  cursor: pointer;
  transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
}
.toggle-cancelled:hover {
  background: linear-gradient(90deg, #c0392b 60%, #ffb3b3 100%) !important;
  box-shadow: 0 4px 16px rgba(231,76,60,0.18);
  transform: translateY(-2px) scale(1.03);
}
  height: 108px;
  background: transparent !important;
}
/* ปุ่มตั้งค่าระบบบัญชี */
.account-settings-btn {
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: background 0.2s;
  margin-left: 10px;
}
.account-settings-btn:hover {
  background: #0056b3;
}

.toggle-section-btn {
  display: inline-block;
  margin: 18px 10px 24px 0;
  padding: 10px 28px;
  font-size: 1.08em;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  transition: background 0.2s, color 0.2s, box-shadow 0.2s;
}
.toggle-approved {
  background: linear-gradient(90deg,#27ae60 60%,#8fd19e 100%);
  color: #fff;
}
.toggle-approved:hover {
  background: linear-gradient(90deg,#219150 60%,#6fcf97 100%);
}
.logout-btn {
  background: #dc3545;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 22px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(220,53,69,0.08);
  transition: background 0.2s, box-shadow 0.2s;
  position: fixed;
  top: 28px;
  right: 38px;
  z-index: 9999;
  margin: 0;
}
.logout-btn:hover {
  background: #b52a37;
}
body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;margin:0;padding:20px;color:#333;transition:all 0.3s}
body.night{background:#121212;color:#eee}
body.night table{border-color:#444}
body.night th{background:#1e1e1e;color:#fff}
body.night tr{background-color:transparent;transition:none;} 
body.night tr:hover{background-color:#2a2a2a;transition:background-color 0.3s;}
body.night .summary-card{background:#1e1e1e;color:#eee;box-shadow:0 4px 12px rgba(0,0,0,0.5)}
body.night td{background-color:#1e1e1e;color:#eee;transition:background-color 0.3s;}
h1{text-align:center;margin-bottom:20px}
h2{margin:10px 0}
/* ปรับขนาดและตำแหน่งกล่อง summary-card */
#top-bar{
  display:flex;
  justify-content:flex-start;
  align-items:flex-start;
  flex-wrap:wrap;
  margin-bottom:20px;
  gap:10px;
  position:relative;
}
.summary-card{
  background:#fff;
  border-radius:12px;
  padding:8px 10px 8px 10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  min-width:100px;
  width:130px;
  max-width:150px;
  display:flex;
  flex-direction:column;
  align-items:center;
  transition:all 0.3s;
}
.summary-card h2{font-size:1.2em;text-align:center;margin-bottom:10px;}
.summary-card span#wallet-info{
    display:block;
    font-size:2em;
    font-weight:bold;
    color:#28a745;
    text-align:center;
    margin-top:10px;
}
.summary-card span#wallet-info::after{
    content: " บาท";
    font-size:1em;
    color:#333;
}
body.night .summary-card span#wallet-info::after{
    color:#eee;
}
/* ปรับ layout กล่อง summary-card ให้เว้นระยะห่างเหมาะสม */
#dashboard {
  display: flex;
  flex-wrap: wrap;
  gap: 32px;
  justify-content: flex-start;
  align-items: flex-start;
  margin-bottom: 24px;
}
#dashboard .summary-card {
  margin-bottom: 0;
  margin-right: 0;
}
#left-column, #right-column {
  flex: 1;
  min-width: 320px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}
#bottom-row {
  margin-top: 28px;
}
@media (max-width: 1100px) {
  #dashboard { gap: 18px; }
  #left-column, #right-column { min-width: 220px; gap: 14px; }
}
@media (max-width: 800px) {
  #dashboard { flex-direction: column; gap: 12px; }
  #left-column, #right-column { min-width: 0; gap: 10px; }
}
.scroll-box{max-height:400px;overflow-y:auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);padding:10px;scroll-behavior:smooth;transition:all 0.3s}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;text-align:center;font-size:0.95em;border-bottom:1px solid #ddd;}
thead th {white-space:nowrap;word-break:normal;max-width:none;}
tbody td {word-break:break-all;max-width:180px;overflow:hidden;text-overflow:ellipsis;}
th{position:sticky;top:0;background:#f8f9fa;z-index:2}
tr:hover{background-color:#f1f5f9;transition:0.3s}
button{padding:5px 10px;border:none;border-radius:6px;cursor:pointer;transition:0.3s;margin:2px}
button.approve{background:#28a745;color:white}
button.approve:hover{background:#218838}
button.cancel{background:#dc3545;color:white}
button.restore{background:#ffc107;color:#333}
button.restore:hover{background:#e0a800}
button.delete-slip{background:#dc3545;color:white;margin-left:5px}
#toggle-mode{position:absolute;top:10px;right:20px;cursor:pointer;font-size:1.5em;}
input.customer-user{width:100%;padding:3px;border-radius:4px;border:1px solid #ccc;box-sizing:border-box}
.paste-area{margin-top:5px;padding:5px;border:1px dashed #ccc;border-radius:4px;min-height:40px;text-align:center;color:#999;font-size:0.85em;}
.paste-area:hover{border-color:#28a745;color:#28a745;}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,0.2);border-radius:4px}
::-webkit-scrollbar-track{background:transparent}

/* Responsive design สำหรับ SCB + Exchange Rates side-by-side */
@media (max-width: 1200px) {
  .scb-exchange-row {
    flex-direction: column !important;
    gap: 12px !important;
  }
  .scb-exchange-row .scb-account-box {
    flex: 1 !important;
    min-width: auto !important;
  }
}

@media (max-width: 768px) {
  .crypto-mini-grid {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 6px !important;
  }
  .crypto-mini-item {
    padding: 8px 4px !important;
  }
}

/* จำกัดความยาวข้อความในคอลัมน์รายละเอียดธุรกรรม SCB ไม่ให้ล้นกล่อง */
.scroll-box td, .scroll-box th {
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
</style>
<style>
/* กล่องอัพโหลดสลิป */
.upload-slip-box {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(108,52,131,0.10);
  padding: 18px 20px 16px 20px;
  margin: 18px auto 0 auto;
  max-width: 340px;
  min-width: 220px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  border: 1.5px solid #e0e0e0;
}
.upload-slip-box h2 {
  margin: 0 0 10px 0;
  font-size: 1.1em;
  color: #6c3483;
}
.upload-slip-box input[type="file"] {
  border: 1px solid #ccc;
  border-radius: 6px;
  background: #fafafa;
  padding: 6px 8px;
  width: 100%;
  font-size: 1em;
  transition: border 0.2s;
}
.upload-slip-box input[type="file"]:focus {
  border: 1.5px solid #6c3483;
  outline: none;
}
.upload-slip-btn {
  background: linear-gradient(90deg,#6c3483 60%,#ff9800 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 24px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(108,52,131,0.08);
  transition: background 0.2s;
}
.upload-slip-btn:hover {
  background: linear-gradient(90deg,#ff9800 60%,#6c3483 100%);
}
.upload-slip-hint {
  font-size: 0.92em;
  color: #888;
  margin-top: 2px;
  text-align: center;
}

/* เครื่องคิดเลข Windows 11 Style */
.calculator-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10000;
  backdrop-filter: blur(4px);
}

.calculator {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #f3f3f3;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  width: 320px;
  padding: 20px;
  font-family: 'Segoe UI', sans-serif;
}

.calculator-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #ddd;
}

.calculator-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
}

.calculator-close {
  background: #e81123;
  color: white;
  border: none;
  border-radius: 6px;
  width: 30px;
  height: 30px;
  cursor: pointer;
  font-size: 1.2em;
  display: flex;
  align-items: center;
  justify-content: center;
}

.calculator-close:hover {
  background: #d10e26;
}

.calculator-display {
  background: white;
  border: 2px solid #e1e1e1;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  text-align: right;
  font-size: 2em;
  font-weight: 300;
  min-height: 40px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  word-break: break-all;
}

.calculator-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.calc-btn {
  background: #ffffff;
  border: 1px solid #e1e1e1;
  border-radius: 8px;
  padding: 15px;
  font-size: 1.1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 50px;
}

.calc-btn:hover {
  background: #f0f0f0;
  transform: translateY(-1px);
}

.calc-btn:active {
  transform: translateY(0);
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.calc-btn.operator {
  background: #0078d4;
  color: white;
}

.calc-btn.operator:hover {
  background: #106ebe;
}

.calc-btn.equals {
  background: #0078d4;
  color: white;
}

.calc-btn.equals:hover {
  background: #106ebe;
}

.calc-btn.clear {
  background: #e81123;
  color: white;
}

.calc-btn.clear:hover {
  background: #d10e26;
}

.calculator-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #0078d4;
  color: white;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 1.5em;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(0, 120, 212, 0.3);
  transition: all 0.3s ease;
  z-index: 9998;
}

.calculator-btn:hover {
  background: #106ebe;
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0, 120, 212, 0.4);
}

.notes-btn {
  position: fixed;
  bottom: 30px;
  right: 100px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 1.5em;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
  transition: all 0.3s ease;
  z-index: 9998;
}

.notes-btn:hover {
  background: #218838;
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

/* กระดาษโน้ต Sticky Notes */
.notes-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10001;
  backdrop-filter: blur(4px);
}

.notes-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  width: 600px;
  max-width: 90vw;
  max-height: 80vh;
  padding: 20px;
  font-family: 'Segoe UI', sans-serif;
  display: flex;
  flex-direction: column;
}

.notes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #ddd;
}

.notes-title {
  font-size: 1.2em;
  font-weight: 600;
  color: #333;
  display: flex;
  align-items: center;
  gap: 8px;
}

.notes-close {
  background: #e81123;
  color: white;
  border: none;
  border-radius: 6px;
  width: 30px;
  height: 30px;
  cursor: pointer;
  font-size: 1.2em;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notes-close:hover {
  background: #d10e26;
}

.new-note-form {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid #e9ecef;
}

.form-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.form-group {
  flex: 1;
}

.form-group label {
  display: block;
  font-size: 1.8em;
  font-weight: 500;
  color: #555;
  margin-bottom: 5px;
}

.form-group input, .form-group textarea {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 1.9em;
  box-sizing: border-box;
}

.form-group textarea {
  resize: vertical;
  min-height: 60px;
}

.add-note-btn {
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 20px;
  cursor: pointer;
  font-weight: 500;
  font-size: 1.8em;
  transition: background 0.2s;
}

.add-note-btn:hover {
  background: #218838;
}

.notes-list {
  flex: 1;
  overflow-y: auto;
  max-height: 400px;
}

.note-item {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  position: relative;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.note-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
  font-size: 0.85em;
  color: #666;
}

.note-meta {
  display: flex;
  gap: 15px;
}

.note-actions {
  display: flex;
  gap: 5px;
}

.edit-note-btn, .delete-note-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 2.2em;
  padding: 2px 6px;
  border-radius: 4px;
  transition: background 0.2s;
}

.edit-note-btn:hover {
  background: #ffc107;
  color: white;
}

.delete-note-btn:hover {
  background: #dc3545;
  color: white;
}

.note-content {
  font-size: 1.9em;
  line-height: 1.4;
  color: #333;
  word-wrap: break-word;
}

.note-amount {
  font-weight: bold;
  color: #28a745;
}

.note-item {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: box-shadow 0.2s;
}

.note-item:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.note-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  border-bottom: 1px solid #f1f3f4;
  padding-bottom: 8px;
}

.note-meta {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

.note-meta span {
  font-size: 1.7em;
  color: #666;
  background: #f8f9fa;
  padding: 3px 8px;
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
}

.note-actions {
  display: flex;
  gap: 5px;
}

.notes-btn {
  position: fixed;
  bottom: 100px;
  right: 30px;
  background: #ffc107;
  color: #333;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 1.5em;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3);
  transition: all 0.3s ease;
  z-index: 9998;
}

.notes-btn:hover {
  background: #e0a800;
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
}

/* Notes Controls - Export/Import */
.notes-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin: 15px 0;
  padding: 10px;
  border-top: 1px solid #e9ecef;
  border-bottom: 1px solid #e9ecef;
}

.export-btn, .import-btn {
  background: #17a2b8;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 1.4em;
  font-weight: 500;
  transition: background 0.2s;
}

.export-btn:hover {
  background: #138496;
}

.import-btn {
  background: #6f42c1;
}

.import-btn:hover {
  background: #5a32a3;
}

/* Pagination Controls */
.pagination-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin-top: 20px;
  padding: 15px;
  border-top: 1px solid #e9ecef;
}

.page-btn {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 1.4em;
  font-weight: 500;
  transition: all 0.2s;
}

.page-btn:hover:not(:disabled) {
  background: #0056b3;
  transform: translateY(-1px);
}

.page-btn:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
}

.page-info {
  font-size: 1.5em;
  font-weight: 500;
  color: #495057;
  padding: 0 10px;
}

/* Exchange Rates Box - Dark Theme Similar to Crypto Trading UI */
.crypto-rates-container {
  background: #1a1a1a;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  padding: 24px;
  margin: 40px auto;
  max-width: 800px;
  color: #ffffff;
  border: 1px solid #333;
  position: relative;
}

.crypto-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid #333;
}

.crypto-title {
  font-size: 1.3em;
  font-weight: 600;
  color: #ffffff;
  display: flex;
  align-items: center;
  gap: 8px;
}

.crypto-subtitle {
  font-size: 0.9em;
  color: #888;
  margin-top: 4px;
}

.refresh-btn {
  background: #2d2d2d;
  border: 1px solid #444;
  border-radius: 6px;
  color: #fff;
  padding: 6px 12px;
  font-size: 0.85em;
  cursor: pointer;
  transition: all 0.2s;
}

.refresh-btn:hover {
  background: #3d3d3d;
  border-color: #555;
}

.crypto-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1px;
  background: #333;
  border-radius: 8px;
  overflow: hidden;
}

.crypto-item {
  background: #2a2a2a;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.2s;
  position: relative;
}

.crypto-item:hover {
  background: #333;
}

.crypto-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.crypto-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  font-weight: bold;
}

.crypto-icon.btc { background: linear-gradient(135deg, #f7931a, #ffb84d); }
.crypto-icon.eth { background: linear-gradient(135deg, #627eea, #8fa2ef); }
.crypto-icon.usdt { background: linear-gradient(135deg, #26a17b, #4fc3a1); }
.crypto-icon.usd { background: linear-gradient(135deg, #2ecc71, #58d68d); color: #fff; }
.crypto-icon.eur { background: linear-gradient(135deg, #3498db, #5dade2); color: #fff; }
.crypto-icon.cny { background: linear-gradient(135deg, #e74c3c, #f1948a); color: #fff; }
.crypto-icon.gold { background: linear-gradient(135deg, #f1c40f, #f7dc6f); color: #333; }
.crypto-icon.other { background: linear-gradient(135deg, #9b59b6, #bb8fce); color: #fff; }

.crypto-info h4 {
  margin: 0;
  font-size: 1em;
  font-weight: 600;
  color: #fff;
}

.crypto-info p {
  margin: 2px 0 0 0;
  font-size: 0.8em;
  color: #888;
}

.crypto-right {
  text-align: right;
}

.crypto-price {
  font-size: 1.1em;
  font-weight: 600;
  color: #fff;
  margin: 0;
}

.crypto-change {
  font-size: 0.85em;
  font-weight: 500;
  margin: 2px 0 0 0;
}

.crypto-change.positive { color: #00ff88; }
.crypto-change.negative { color: #ff4757; }
.crypto-change.neutral { color: #888; }

.crypto-footer {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid #333;
  text-align: center;
  font-size: 0.85em;
  color: #888;
}

/* Loading Animation */
.crypto-loading {
  display: inline-block;
  width: 12px;
  height: 12px;
  border: 2px solid #333;
  border-radius: 50%;
  border-top-color: #fff;
  animation: cryptoSpin 1s ease-in-out infinite;
  margin-right: 6px;
}

@keyframes cryptoSpin {
  to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .crypto-grid {
    grid-template-columns: 1fr;
  }
  
  .crypto-rates-container {
    margin: 20px 10px;
    padding: 16px;
  }
  
  .crypto-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
}
</style>
</head>
<body>
  {% include 'balance_marquee.html' %}
<!-- โลโก้หัวเว็บ (2 โลโก้, ขนาดเหมาะสม, อยู่กลาง, ซ่อนหลัง 5 นาที) -->
<div class="header-logos" id="header-logos">
  <img src="{{ url_for('static', filename='5e9e7571-ef8d-4e7c-9e51-6b50221aceec.png') }}" alt="Logo1" style="height:80px;max-width:160px;width:auto;object-fit:contain;margin:0 16px;">
  <img src="{{ url_for('static', filename='ngox-header.png.png') }}" alt="NGOX Logo" style="height:80px;max-width:160px;width:auto;object-fit:contain;margin:0 16px;">
</div>

<h1>Dashboard(Realtime)</h1>

<div id="top-bar">
  <div style="display:flex;gap:32px;justify-content:center;align-items:flex-start;flex-wrap:wrap;margin-bottom:24px;width:100%;">
    <div class="summary-card" style="position:relative;min-width:220px;max-width:320px;width:260px;padding:32px 18px 24px 18px;">
      <div style="position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:6px;">
        <span id="tw-tk-status-light" style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ccc;border:2px solid #888;"></span>
        <span id="tw-tk-status-text" style="font-size:0.95em;color:#555;">สถานะ: -</span>
      </div>
      <h2 style="margin-top:32px;">💰 Truewallet TK</h2>
      <span id="tw-balance" style="display:block;font-size:2em;font-weight:bold;color:#28a745;text-align:center;margin-top:10px;">-</span>
      <div id="tw-info" style="font-size:1em;color:#555;text-align:center;margin-top:4px;">
        <span id="tw-mobile">-</span><br>
        <span id="tw-updated">-</span>
      </div>
      <div style="margin-top:10px;text-align:center;">
        <button onclick="resetApproved()">รีเซทรายการอนุมัติ</button>
        <button onclick="resetCancelled()">รีเซทรายการยกเลิก</button>
      </div>
    </div>
    <div class="summary-card" id="account-balance-box" style="position:relative;min-width:220px;max-width:320px;width:260px;padding:32px 18px 24px 18px;">
      <div style="position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:6px;z-index:2;">
        <img src="{{ url_for('static', filename='scb-logo.png') }}" alt="SCB Logo" style="height:24px;width:auto;vertical-align:middle;">
        <span id="scb-status-light" style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ccc;border:2px solid #888;margin-left:4px;"></span>
        <span id="scb-status-text" style="font-size:0.95em;color:#555;margin-left:4px;">เชื่อมต่อ...</span>
      </div>
      <div style="font-size:1.1em;font-weight:bold;color:#6c3483;margin-top:28px;">4272014229</div>
      <h2 style="margin-top:4px;font-size:1.1em;margin-bottom:8px;">SCB สุมิธร์ คิมภิรานนท์</h2>
      <span id="account-balance-info" style="display:block;font-size:2em;font-weight:bold;color:#ff9800;text-align:center;margin-top:10px;">0 บาท</span>
      <div style="font-size:0.95em;color:#888;text-align:center;margin-top:2px;">ยอดคงเหลือล่าสุด</div>
    </div>
    
    <div class="summary-card" id="account-balance-box2" style="position:relative;min-width:220px;max-width:320px;width:260px;padding:32px 18px 24px 18px;">
      <div style="position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:6px;z-index:2;">
        <img src="{{ url_for('static', filename='scb-logo.png') }}" alt="SCB Logo" style="height:24px;width:auto;vertical-align:middle;">
        <span id="scb2-status-light" style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ccc;border:2px solid #888;margin-left:4px;"></span>
        <span id="scb2-status-text" style="font-size:0.95em;color:#555;margin-left:4px;">เชื่อมต่อ...</span>
      </div>
      <div style="font-size:1.1em;font-weight:bold;color:#6c3483;margin-top:28px;">4272014619</div>
      <h2 style="margin-top:4px;font-size:1.1em;margin-bottom:8px;">SCB พลอยไพริน นามโคตร</h2>
      <span id="account-balance-info2" style="display:block;font-size:2em;font-weight:bold;color:#ff9800;text-align:center;margin-top:10px;">0 บาท</span>
      <div style="font-size:0.95em;color:#888;text-align:center;margin-top:2px;">ยอดคงเหลือล่าสุด</div>
    </div>
    <div class="summary-card" id="tw-bb-box" style="position:relative;min-width:220px;max-width:320px;width:260px;padding:32px 18px 24px 18px;">
      <h2>🪙 Truewallet BB ENJ</h2>
      <span id="tw-bb-balance" style="display:block;font-size:2em;font-weight:bold;color:#28a745;text-align:center;margin-top:10px;">-</span>
      <div id="tw-bb-info" style="font-size:1em;color:#555;text-align:center;margin-top:4px;">
          <div style="position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:6px;z-index:2;">
            <span id="tw-bb-status-light" style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ccc;border:2px solid #888;"></span>
            <span id="tw-bb-status-text" style="font-size:0.95em;color:#555;">สถานะ: -</span>
          </div>
        <span id="tw-bb-mobile">-</span><br>
        <span id="tw-bb-updated">-</span>
      </div>
    </div>
    <div class="summary-card" id="tw-bp-box" style="position:relative;min-width:220px;max-width:320px;width:260px;padding:32px 18px 24px 18px;">
      <div style="position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:6px;">
        <span id="tw-bp-status-light" style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ccc;border:2px solid #888;"></span>
        <span id="tw-bp-status-text" style="font-size:0.95em;color:#555;">สถานะ: -</span>
      </div>
      <h2>🧧 Truewallet BP</h2>
      <span id="tw-bp-balance" style="display:block;font-size:2em;font-weight:bold;color:#28a745;text-align:center;margin-top:10px;">-</span>
      <div id="tw-bp-info" style="font-size:1em;color:#555;text-align:center;margin-top:4px;">
        <span id="tw-bp-mobile">-</span><br>
        <span id="tw-bp-updated">-</span>
      </div>
    </div>
  </div>
  <!-- กล่อง SCB ทั้งสองใบอยู่ในกลุ่มอื่น (เช่น right-column) ตาม layout เดิม -->
  <div style="display:flex;align-items:center;gap:10px;">
  <button class="account-settings-btn" onclick="window.location.href='/account_settings'">⚙️ ตั้งค่าระบบบัญชี</button>
<button class="logout-btn" onclick="window.location.href='/logout'">ออกจากระบบ</button>
    <div id="toggle-mode">🌞</div>
  </div>
</div>

<!-- เครื่องคิดเลข Windows 11 -->
<div class="calculator-overlay" id="calculator-overlay">
  <div class="calculator">
    <div class="calculator-header">
      <div class="calculator-title">เครื่องคิดเลข</div>
      <button class="calculator-close" onclick="closeCalculator()">×</button>
    </div>
    <div class="calculator-display" id="calc-display">0</div>
    <div class="calculator-buttons">
      <button class="calc-btn clear" onclick="clearCalculator()">C</button>
      <button class="calc-btn clear" onclick="clearEntry()">CE</button>
      <button class="calc-btn" onclick="backspace()">⌫</button>
      <button class="calc-btn operator" onclick="inputOperator('/')">÷</button>
      
      <button class="calc-btn" onclick="inputNumber('7')">7</button>
      <button class="calc-btn" onclick="inputNumber('8')">8</button>
      <button class="calc-btn" onclick="inputNumber('9')">9</button>
      <button class="calc-btn operator" onclick="inputOperator('*')">×</button>
      
      <button class="calc-btn" onclick="inputNumber('4')">4</button>
      <button class="calc-btn" onclick="inputNumber('5')">5</button>
      <button class="calc-btn" onclick="inputNumber('6')">6</button>
      <button class="calc-btn operator" onclick="inputOperator('-')">−</button>
      
      <button class="calc-btn" onclick="inputNumber('1')">1</button>
      <button class="calc-btn" onclick="inputNumber('2')">2</button>
      <button class="calc-btn" onclick="inputNumber('3')">3</button>
      <button class="calc-btn operator" onclick="inputOperator('+')">+</button>
      
      <button class="calc-btn" onclick="toggleSign()">±</button>
      <button class="calc-btn" onclick="inputNumber('0')">0</button>
      <button class="calc-btn" onclick="inputDecimal()">.</button>
      <button class="calc-btn equals" onclick="calculate()">=</button>
    </div>
  </div>
</div>

<!-- ปุ่มเปิดเครื่องคิดเลข -->
<button class="calculator-btn" onclick="openCalculator()" title="เครื่องคิดเลข">🔢</button>

<!-- ปุ่มเปิดกระดาษโน้ต -->
<button class="notes-btn" onclick="openNotes()" title="กระดาษโน้ต">📝</button>

<!-- กระดาษโน้ต -->
<div class="notes-overlay" id="notes-overlay">
  <div class="notes-container">
    <div class="notes-header">
      <div class="notes-title">📝 กระดาษโน้ต</div>
      <button class="notes-close" onclick="closeNotes()">×</button>
    </div>
    
    <div class="new-note-form">
      <div class="form-row">
        <div class="form-group">
          <label>วันที่/เวลา</label>
          <input type="text" id="note-datetime" readonly>
        </div>
        <div class="form-group">
          <label>ยอดเงิน</label>
          <input type="text" id="note-amount" placeholder="เช่น 1,000.00">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ผู้เขียน</label>
          <input type="text" id="note-author" placeholder="ชื่อผู้เขียน">
        </div>
      </div>
      <div class="form-group">
        <label>รายละเอียด</label>
        <textarea id="note-details" placeholder="รายละเอียดการทำรายการ..."></textarea>
      </div>
      <button class="add-note-btn" onclick="addNote()">เพิ่มโน้ต</button>
    </div>
    
    <!-- Export/Import Controls -->
    <div class="notes-controls">
      <button class="export-btn" onclick="exportNotes()" title="ส่งออก CSV สำหรับ Google Sheets">📊 ส่งออก CSV</button>
      <button class="import-btn" onclick="importNotes()" title="นำเข้าไฟล์ CSV จาก Google Sheets">📥 นำเข้า CSV</button>
    </div>
    
    <div class="notes-list" id="notes-list">
      <!-- โน้ตจะแสดงที่นี่ -->
    </div>
    
    <!-- Pagination Controls -->
    <div class="pagination-controls">
      <button id="prev-page" class="page-btn" onclick="prevPage()">◀ ก่อนหน้า</button>
      <span id="page-info" class="page-info">หน้า 1 จาก 1</span>
      <button id="next-page" class="page-btn" onclick="nextPage()">ถัดไป ▶</button>
    </div>
  </div>
</div>

<div id="dashboard">
  <!-- กล่อง SCB SMS, TrueWallet ขึ้นมาอยู่แถวเดียวกัน -->
  <div style="display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 32px; width: 100%; margin-bottom: 32px;">
    <!-- SCB SMS (2 กล่อง) -->
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <!-- แถวที่ 1: SCB สุมิธร์ คิมภิรานนท์ และ อัตราแลกเปลี่ยน side-by-side -->
      <div class="scb-exchange-row" style="display: flex; gap: 16px; align-items: flex-start; flex-direction: column;">
        <!-- แถวบน: SCB สุมิธร์ เต็มความกว้าง -->
        <div class="scb-account-box" style="background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:16px; width: 100%;">
          <div style="display:flex;align-items:center;gap:10px; margin-bottom:8px;">
            <img src="{{ url_for('static', filename='scb-logo.png') }}" alt="SCB Logo" style="height:32px;max-width:80px;width:auto;">
            <span id="scb-status-light" style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ccc;border:2px solid #888;"></span>
            <span id="scb-status-text">เชื่อมต่อ...</span>
          </div>
          <div style="margin-bottom:8px;">
            <span style="font-weight:bold;">SCB สุมิธร์ คิมภิรานนท์</span>
          </div>
          <div class="scroll-box" style="width: 100%; max-height: 220px; overflow-y: auto; border:none">
            <table id="scb-sms-table" style="width:100%;border:none">
              <thead>
                <tr>
                  <th>วันที่/เวลา</th>
                  <th>รายละเอียด</th>
                  <th>ยอดคงเหลือ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <!-- แถวล่าง: SCB พลอยไพริน + Exchange Rates แบบ side-by-side -->
        <div style="display: flex; gap: 16px; align-items: flex-start; width: 100%; margin-top: -6px;">
          <div class="scb-account-box" style="background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:16px; flex: 1; min-width: 400px;">
            <div style="display:flex;align-items:center;gap:10px; margin-bottom:8px;">
              <img src="{{ url_for('static', filename='scb-logo.png') }}" alt="SCB Logo" style="height:32px;max-width:80px;width:auto;">
              <span id="scb2-status-light" style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ccc;border:2px solid #888;"></span>
              <span id="scb2-status-text">เชื่อมต่อ...</span>
            </div>
            <div style="margin-bottom:8px;">
              <span style="font-weight:bold;">SCB พลอยไพริน นามโคตร</span>
            </div>
            <div class="scroll-box" style="width: 100%; max-height: 220px; overflow-y: auto; border:none">
              <table id="scb2-sms-table" style="width:100%;border:none">
                <thead>
                  <tr>
                    <th>วันที่/เวลา</th>
                    <th>รายละเอียด</th>
                    <th>ยอดคงเหลือ</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          
          <!-- กล่องอัตราแลกเปลี่ยน ด้านขวา -->
          <div class="scb-account-box" style="background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:16px; flex: 0 0 380px; min-width: 380px;">
            <div class="crypto-header" style="margin-bottom: 14px; text-align: center;">
              <div class="crypto-title" style="font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 3px;">
                💱 อัตราแลกเปลี่ยนเงินตรา & ราคาทอง
              </div>
              <div class="crypto-subtitle" style="font-size: 0.85em; color: #666;">
                ข้อมูลราคาแบบเรียลไทม์
              </div>
            </div>
            
            <div class="crypto-mini-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
              <!-- BTC -->
              <div class="crypto-mini-item" style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;">
                  <span style="font-size: 1.1em;">₿</span>
                  <span style="font-size: 0.9em; font-weight: 600;">BTC</span>
                </div>
                <div style="font-size: 0.85em; font-weight: 600; line-height: 1.2;" id="btc-price-mini">2,480K บาท</div>
                <div style="font-size: 0.75em; color: #00ff88; margin-top: 3px;" id="btc-change-mini">+1.8%</div>
              </div>
              
              <!-- USDT -->
              <div class="crypto-mini-item" style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;">
                  <span style="font-size: 1.1em;">₮</span>
                  <span style="font-size: 0.9em; font-weight: 600;">USDT</span>
                </div>
                <div style="font-size: 0.85em; font-weight: 600; line-height: 1.2;" id="usdt-price-mini">36.20 บาท</div>
                <div style="font-size: 0.75em; color: #00ff88; margin-top: 3px;" id="usdt-change-mini">+0.1%</div>
              </div>
              
              <!-- USD -->
              <div class="crypto-mini-item" style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;">
                  <span style="font-size: 1.1em;">$</span>
                  <span style="font-size: 0.9em; font-weight: 600;">USD</span>
                </div>
                <div style="font-size: 0.85em; font-weight: 600; line-height: 1.2;" id="usd-price-mini">36.25 บาท</div>
                <div style="font-size: 0.75em; color: #888; margin-top: 3px;" id="usd-change-mini">--</div>
              </div>
              
              <!-- EUR -->
              <div class="crypto-mini-item" style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;">
                  <span style="font-size: 1.1em;">€</span>
                  <span style="font-size: 0.9em; font-weight: 600;">EUR</span>
                </div>
                <div style="font-size: 0.85em; font-weight: 600; line-height: 1.2;" id="eur-price-mini">38.45 บาท</div>
                <div style="font-size: 0.75em; color: #888; margin-top: 3px;" id="eur-change-mini">--</div>
              </div>
              
              <!-- CNY -->
              <div class="crypto-mini-item" style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;">
                  <span style="font-size: 1.1em;">¥</span>
                  <span style="font-size: 0.9em; font-weight: 600;">CNY</span>
                </div>
                <div style="font-size: 0.85em; font-weight: 600; line-height: 1.2;" id="cny-price-mini">5.08 บาท</div>
                <div style="font-size: 0.75em; color: #888; margin-top: 3px;" id="cny-change-mini">--</div>
              </div>
              
              <!-- GOLD -->
              <div class="crypto-mini-item" style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;">
                  <span style="font-size: 1.1em;">🥇</span>
                  <span style="font-size: 0.9em; font-weight: 600;">GOLD</span>
                </div>
                <div style="font-size: 0.85em; font-weight: 600; line-height: 1.2;" id="gold-price-mini">41,250 บาท</div>
                <div style="font-size: 0.75em; color: #00ff88; margin-top: 3px;" id="gold-change-mini">+0.5%</div>
              </div>
            </div>
            
            <div style="text-align: center; font-size: 0.8em; color: #888; border-top: 1px solid #eee; padding-top: 8px;">
              <span id="crypto-status-mini">🔄 กำลังเตรียมข้อมูล...</span>
              <br>
              <button onclick="refreshCryptoRates()" style="font-size: 0.75em; padding: 3px 10px; margin-top: 4px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">รีเฟรช</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</style>
<script>
// ปุ่ม toggle แสดง/ซ่อน Approved/Cancelled ใต้ wallet deposit
document.getElementById('show-approved').addEventListener('click', function() {
  document.getElementById('approved-section').style.display = 'block';
  document.getElementById('cancelled-section').style.display = 'none';
  document.getElementById('approved-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
});
document.getElementById('show-cancelled').addEventListener('click', function() {
  document.getElementById('approved-section').style.display = 'none';
  document.getElementById('cancelled-section').style.display = 'block';
  document.getElementById('cancelled-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
});
</script>
  </div>
</div>




<script>
// --- อัปเดตสถานะไฟและข้อความทุกกล่อง summary-card ---
let statusCache = {};
let lastStatusUpdate = 0;

async function updateStatusLights() {
  // Throttle updates - only check every 15 seconds instead of 3
  const now = Date.now();
  if (now - lastStatusUpdate < 15000) return;
  lastStatusUpdate = now;

  // Truewallet TK
  try {
    const resp = await fetch('https://apis.truemoneyservices.com/account/v1/balance', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer dce99fdf74189d0854c0eeb627c1f4d8' }
    });
    const newStatus = resp.ok ? 'connected' : 'disconnected';
    if (statusCache.twTk !== newStatus) {
      statusCache.twTk = newStatus;
      document.getElementById('tw-tk-status-light').style.background = resp.ok ? '#28a745' : '#ccc';
      document.getElementById('tw-tk-status-text').innerText = resp.ok ? 'เชื่อมต่อสำเร็จ' : '';
    }
  } catch (e) {
    if (statusCache.twTk !== 'error') {
      statusCache.twTk = 'error';
      document.getElementById('tw-tk-status-light').style.background = '#ccc';
      document.getElementById('tw-tk-status-text').innerText = '';
    }
  }
  
  // SCB สุมิธร์ - use cached data
  try {
    const resp = await fetch(`/api/sms?tag=sumitkimphiranon&sender=027777777`);
    let data = await resp.json();
    const status = data.status || '';
    if (statusCache.scb1 !== status) {
      statusCache.scb1 = status;
      const scbStatusText = document.getElementById('scb-status-text');
      if (status === 'connected') {
        document.getElementById('scb-status-light').style.background = '#28a745';
        scbStatusText.innerText = 'เชื่อมต่อสำเร็จ';
      } else {
        document.getElementById('scb-status-light').style.background = '#ccc';
        scbStatusText.innerText = 'เชื่อมต่อ...';
      }
    }
  } catch (e) {
    if (statusCache.scb1 !== 'error') {
      statusCache.scb1 = 'error';
      document.getElementById('scb-status-light').style.background = '#ccc';
      document.getElementById('scb-status-text').innerText = 'เชื่อมต่อ...';
    }
  }
  
  // SCB พลอยไพริน
  try {
    const resp = await fetch(`/api/sms?tag=ploypairinnamkhot&sender=027777777`);
    let data = await resp.json();
    const status2 = data.status || '';
    if (statusCache.scb2 !== status2) {
      statusCache.scb2 = status2;
      const scb2StatusText = document.getElementById('scb2-status-text');
      if (status2 === 'connected') {
        document.getElementById('scb2-status-light').style.background = '#28a745';
        scb2StatusText.innerText = 'เชื่อมต่อสำเร็จ';
      } else {
        document.getElementById('scb2-status-light').style.background = '#ccc';
        scb2StatusText.innerText = 'เชื่อมต่อ...';
      }
    }
  } catch (e) {
    if (statusCache.scb2 !== 'error') {
      statusCache.scb2 = 'error';
      document.getElementById('scb2-status-light').style.background = '#ccc';
      document.getElementById('scb2-status-text').innerText = 'เชื่อมต่อ...';
    }
  }
  
  // SCB กฤษฏา สุดแม่ง
  try {
    const resp = await fetch(`https://xinon1565.up.railway.app/api/sms?tag=168&sender=027777777`);
    let data = await resp.json();
    const status3 = data.status || '';
    if (statusCache.scb3 !== status3) {
      statusCache.scb3 = status3;
      const scb3StatusText = document.getElementById('scb3-status-text');
      if (status3 === 'connected') {
        document.getElementById('scb3-status-light').style.background = '#28a745';
        scb3StatusText.innerText = 'เชื่อมต่อสำเร็จ';
      } else {
        document.getElementById('scb3-status-light').style.background = '#ccc';
        scb3StatusText.innerText = 'เชื่อมต่อ...';
      }
    }
  } catch (e) {
    if (statusCache.scb3 !== 'error') {
      statusCache.scb3 = 'error';
      document.getElementById('scb3-status-light').style.background = '#ccc';
      document.getElementById('scb3-status-text').innerText = 'เชื่อมต่อ...';
    }
  }
  
  // Truewallet BB ENJ
  try {
    const respBB = await fetch('https://apis.truemoneyservices.com/account/v1/balance', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer 4cb88e53852339a9257c6fa1dccdb6af' }
    });
    const newStatusBB = respBB.ok ? 'connected' : 'disconnected';
    if (statusCache.twBB !== newStatusBB) {
      statusCache.twBB = newStatusBB;
      document.getElementById('tw-bb-status-light').style.background = respBB.ok ? '#28a745' : '#ccc';
      document.getElementById('tw-bb-status-text').innerText = respBB.ok ? 'เชื่อมต่อสำเร็จ' : '';
    }
  } catch (e) {
    if (statusCache.twBB !== 'error') {
      statusCache.twBB = 'error';
      document.getElementById('tw-bb-status-light').style.background = '#ccc';
      document.getElementById('tw-bb-status-text').innerText = '';
    }
  }
  
  // Truewallet BP
  try {
    const respBP = await fetch('https://apis.truemoneyservices.com/account/v1/balance', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer 2ecade3f36166b2b9858e281e95c8560' }
    });
    const newStatusBP = respBP.ok ? 'connected' : 'disconnected';
    if (statusCache.twBP !== newStatusBP) {
      statusCache.twBP = newStatusBP;
      document.getElementById('tw-bp-status-light').style.background = respBP.ok ? '#28a745' : '#ccc';
      document.getElementById('tw-bp-status-text').innerText = respBP.ok ? 'เชื่อมต่อสำเร็จ' : '';
    }
  } catch (e) {
    if (statusCache.twBP !== 'error') {
      statusCache.twBP = 'error';
      document.getElementById('tw-bp-status-light').style.background = '#ccc';
      document.getElementById('tw-bp-status-text').innerText = '';
    }
  }
}
setInterval(updateStatusLights, 5000);
window.addEventListener('DOMContentLoaded', updateStatusLights);
// --- ดึงยอด Truewallet BP ผ่าน API แล้วแสดงผล ---
let lastBPUpdate = 0;
let cachedBPData = null;

async function fetchTruewalletBPBalance() {
  const now = Date.now();
  // Update only every 30 seconds instead of 10
  if (now - lastBPUpdate < 30000 && cachedBPData) {
    return;
  }
  
  try {
    const resp = await fetch('https://apis.truemoneyservices.com/account/v1/balance', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer 2ecade3f36166b2b9858e281e95c8560'
      }
    });
    if (!resp.ok) throw new Error('API Error');
    const data = await resp.json();
    
    if (data.status === 'ok' && data.data) {
      const newData = {
        balance: data.data.balance ? (parseInt(data.data.balance, 10) / 100).toLocaleString('en-US', {minimumFractionDigits:2}) : '-',
        mobile: 'เบอร์: ' + (data.data.mobile_no || '-'),
        updated: 'อัปเดต: ' + (data.data.updated_at || '-')
      };
      
      // Only update DOM if data changed
      if (!cachedBPData || JSON.stringify(cachedBPData) !== JSON.stringify(newData)) {
        cachedBPData = newData;
        document.getElementById('tw-bp-balance').innerText = newData.balance + ' บาท';
        document.getElementById('tw-bp-mobile').innerText = newData.mobile;
        document.getElementById('tw-bp-updated').innerText = newData.updated;
        lastBPUpdate = now;
      }
    } else {
      if (!cachedBPData || cachedBPData.balance !== '-') {
        cachedBPData = { balance: '-', mobile: '-', updated: '-' };
        document.getElementById('tw-bp-balance').innerText = '-';
        document.getElementById('tw-bp-mobile').innerText = '-';
        document.getElementById('tw-bp-updated').innerText = '-';
      }
    }
  } catch (e) {
    if (!cachedBPData || cachedBPData.balance !== '-') {
      cachedBPData = { balance: '-', mobile: '-', updated: '-' };
      document.getElementById('tw-bp-balance').innerText = '-';
      document.getElementById('tw-bp-mobile').innerText = '-';
      document.getElementById('tw-bp-updated').innerText = '-';
    }
  }
}
setInterval(fetchTruewalletBPBalance, 15000); // Reduced frequency
fetchTruewalletBPBalance();
// --- ดึงยอด Truewallet BB ENJ ผ่าน API แล้วแสดงผล ---
let lastBBUpdate = 0;
let cachedBBData = null;

async function fetchTruewalletBBBalance() {
  const now = Date.now();
  // Update only every 30 seconds instead of 10
  if (now - lastBBUpdate < 30000 && cachedBBData) {
    return;
  }
  
  try {
    const resp = await fetch('https://apis.truemoneyservices.com/account/v1/balance', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer 4cb88e53852339a9257c6fa1dccdb6af'
      }
    });
    if (!resp.ok) throw new Error('API Error');
    const data = await resp.json();
    
    if (data.status === 'ok' && data.data) {
      const newData = {
        balance: data.data.balance ? (parseInt(data.data.balance, 10) / 100).toLocaleString('en-US', {minimumFractionDigits:2}) : '-',
        mobile: 'เบอร์: ' + (data.data.mobile_no || '-'),
        updated: 'อัปเดต: ' + (data.data.updated_at || '-')
      };
      
      // Only update DOM if data changed
      if (!cachedBBData || JSON.stringify(cachedBBData) !== JSON.stringify(newData)) {
        cachedBBData = newData;
        document.getElementById('tw-bb-balance').innerText = newData.balance + ' บาท';
        document.getElementById('tw-bb-mobile').innerText = newData.mobile;
        document.getElementById('tw-bb-updated').innerText = newData.updated;
        lastBBUpdate = now;
      }
    } else {
      if (!cachedBBData || cachedBBData.balance !== '-') {
        cachedBBData = { balance: '-', mobile: '-', updated: '-' };
        document.getElementById('tw-bb-balance').innerText = '-';
        document.getElementById('tw-bb-mobile').innerText = '-';
        document.getElementById('tw-bb-updated').innerText = '-';
      }
    }
  } catch (e) {
    if (!cachedBBData || cachedBBData.balance !== '-') {
      cachedBBData = { balance: '-', mobile: '-', updated: '-' };
      document.getElementById('tw-bb-balance').innerText = '-';
      document.getElementById('tw-bb-mobile').innerText = '-';
      document.getElementById('tw-bb-updated').innerText = '-';
    }
  }
}
setInterval(fetchTruewalletBBBalance, 15000); // Reduced frequency
fetchTruewalletBBBalance();
// --- ดึงยอด TrueMoney Wallet ผ่าน API แล้วแสดงผล ---
let lastTKUpdate = 0;
let cachedTKData = null;

async function fetchTruewalletBalance() {
  const now = Date.now();
  // Update only every 30 seconds instead of 10
  if (now - lastTKUpdate < 30000 && cachedTKData) {
    return;
  }
  
  try {
    const resp = await fetch('https://apis.truemoneyservices.com/account/v1/balance', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer dce99fdf74189d0854c0eeb627c1f4d8'
      }
    });
    if (!resp.ok) throw new Error('API Error');
    const data = await resp.json();
    
    if (data.status === 'ok' && data.data) {
      const newData = {
        balance: data.data.balance ? (parseInt(data.data.balance, 10) / 100).toLocaleString('en-US', {minimumFractionDigits:2}) : '-',
        mobile: 'เบอร์: ' + (data.data.mobile_no || '-'),
        updated: 'อัปเดต: ' + (data.data.updated_at || '-')
      };
      
      // Only update DOM if data changed
      if (!cachedTKData || JSON.stringify(cachedTKData) !== JSON.stringify(newData)) {
        cachedTKData = newData;
        document.getElementById('tw-balance').innerText = newData.balance + ' บาท';
        document.getElementById('tw-mobile').innerText = newData.mobile;
        document.getElementById('tw-updated').innerText = newData.updated;
        lastTKUpdate = now;
      }
    } else {
      if (!cachedTKData || cachedTKData.balance !== '-') {
        cachedTKData = { balance: '-', mobile: '-', updated: '-' };
        document.getElementById('tw-balance').innerText = '-';
        document.getElementById('tw-mobile').innerText = '-';
        document.getElementById('tw-updated').innerText = '-';
      }
    }
  } catch (e) {
    if (!cachedTKData || cachedTKData.balance !== '-') {
      cachedTKData = { balance: '-', mobile: '-', updated: '-' };
      document.getElementById('tw-balance').innerText = '-';
      document.getElementById('tw-mobile').innerText = '-';
      document.getElementById('tw-updated').innerText = '-';
    }
  }
}
setInterval(fetchTruewalletBalance, 15000); // Reduced frequency
fetchTruewalletBalance();
// --- ซ่อนโลโก้หัวเว็บหลังเข้าเว็บ 5 นาที ---
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    var logos = document.getElementById('header-logos');
    if (logos) logos.style.display = 'none';
  }, 300000); // 5 นาที = 300,000 ms
});
// --- ดึงยอดคงเหลือ SCB สุมิธร์ คิมภิรานนท์ และ พลอยไพริน นามโคตร มาแสดงในกล่องใหม่ ---
let lastBalanceUpdate = 0;
let cachedBalanceData = {};

async function updateAccountBalanceBox() {
  const now = Date.now();
  // Update only every 20 seconds instead of 3
  if (now - lastBalanceUpdate < 20000 && Object.keys(cachedBalanceData).length > 0) {
    return;
  }
  
  try {
    const apiBase = 'https://xinon1565.up.railway.app';
    const resp = await fetch(`${apiBase}/api/sms?tag=sumitkimphiranon&sender=027777777`);
    const data = await resp.json();
    let smsList = Array.isArray(data.sms) ? data.sms : [];
    let latest = smsList.length > 0 ? smsList[0] : null;
    let balance = latest && latest.balance ? latest.balance.replace(/[^\d.,]/g, '') : '0';
    
    // Only update if balance changed
    if (!cachedBalanceData.scb1 || cachedBalanceData.scb1.balance !== balance) {
      cachedBalanceData.scb1 = { balance, status: data.status };
      document.getElementById('account-balance-info').innerText = balance + ' บาท';
      document.getElementById('scb-status-light').style.background = (data.status === 'connected') ? '#28a745' : '#ccc';
    }
  } catch (e) {
    if (!cachedBalanceData.scb1 || cachedBalanceData.scb1.balance !== '0') {
      cachedBalanceData.scb1 = { balance: '0', status: 'error' };
      document.getElementById('account-balance-info').innerText = '0';
      document.getElementById('scb-status-light').style.background = 'red';
    }
  }
  
  try {
    const apiBase = 'https://xinon1565.up.railway.app';
    const resp2 = await fetch(`${apiBase}/api/sms?tag=ploypairinnamkhot&sender=027777777`);
    const data2 = await resp2.json();
    let smsList2 = Array.isArray(data2.sms) ? data2.sms : [];
    let latest2 = smsList2.length > 0 ? smsList2[0] : null;
    let balance2 = latest2 && latest2.balance ? latest2.balance.replace(/[^\d.,]/g, '') : '0';
    
    // Only update if balance changed
    if (!cachedBalanceData.scb2 || cachedBalanceData.scb2.balance !== balance2) {
      cachedBalanceData.scb2 = { balance: balance2, status: data2.status };
      document.getElementById('account-balance-info2').innerText = balance2 + ' บาท';
      document.getElementById('scb2-status-light').style.background = (data2.status === 'connected') ? '#28a745' : '#ccc';
      lastBalanceUpdate = now;
    }
  } catch (e) {
    if (!cachedBalanceData.scb2 || cachedBalanceData.scb2.balance !== '0') {
      cachedBalanceData.scb2 = { balance: '0', status: 'error' };
      document.getElementById('account-balance-info2').innerText = '0';
      document.getElementById('scb2-status-light').style.background = 'red';
    }
  }
}
setInterval(updateAccountBalanceBox, 10000); // Reduced frequency
updateAccountBalanceBox();
// --- ปุ่มเปิด/ปิดโหมดกลางคืน ---
document.addEventListener('DOMContentLoaded', function() {
  const toggleModeBtn = document.getElementById('toggle-mode');
  toggleModeBtn.addEventListener('click', function() {
    document.body.classList.toggle('night');
    if(document.body.classList.contains('night')) {
      toggleModeBtn.textContent = '🌙';
    } else {
      toggleModeBtn.textContent = '🌞';
    }
  });
});
// --- ดึงข้อมูล SCB สุมิธร์ มาแสดงในกล่อง SCB พลอยไพริน (copy data) ---
async function fetchScbSummaryBox() {
  try {
    const tbody = document.querySelector('#scb-summary-table tbody');
    if (!tbody) {
      console.log('SCB summary table not found, skipping...');
      return;
    }
    
    const resp = await fetch(`/api/sms?tag=sumitkimphiranon&sender=027777777`);
    const data = await resp.json();
    let smsList = Array.isArray(data) ? data : (data.sms_list || []);
    if (smsList.length > 5) smsList = smsList.slice(-5);
    smsList = smsList.reverse();
    
    tbody.innerHTML = '';
    smsList.forEach(sms => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${sms.date_time || '-'}</td><td>${sms.detail || '-'}</td><td>${sms.balance || '-'}</td>`;
      tbody.appendChild(tr);
    });
  } catch (e) {
    const tbody = document.querySelector('#scb-summary-table tbody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="3">ไม่สามารถโหลดข้อมูล SMS ได้</td></tr>';
    }
  }
}
setInterval(fetchScbSummaryBox, 3000);
fetchScbSummaryBox();

// --- ดึง SMS จาก API และแสดงในแต่ละตาราง พร้อมเปลี่ยนชื่อบัญชีและ tag ได้ ---



async function fetchScbSms(tableId, statusLightId, statusTextId, tag) {
  const statusLight = document.getElementById(statusLightId);
  const statusText = document.getElementById(statusTextId);
  try {
    let apiUrl, apiBase;
    
    // ตรวจสอบว่าเป็น SCB กฤษฏา สุดแม่ง (scb3) หรือไม่
    if (tableId === 'scb3-sms-table') {
      apiUrl = `https://xinon1565.up.railway.app/api/sms?tag=168&sender=027777777`;
    } else {
      // URL ของ API ปกติสำหรับ SCB อื่นๆ
      apiBase = 'https://xinon1565.up.railway.app'; // production API
      apiUrl = `${apiBase}/api/sms?tag=${tag}&sender=027777777`;
    }
    
    const resp = await fetch(apiUrl);
    const data = await resp.json();
    if (data.status === 'connected') {
      statusLight.style.background = '#28a745';
      statusText.innerText = 'เชื่อมต่อสำเร็จ';
    } else {
      statusLight.style.background = '#ccc';
      statusText.innerText = 'เชื่อมต่อ...';
    }
    let smsList = Array.isArray(data.sms) ? data.sms : [];
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = '';
    
    // ตรวจสอบว่าเป็นตาราง OTP (scb3) หรือ SMS ธรรมดา
    if (tableId === 'scb3-sms-table') {
      // แสดงข้อมูล OTP สำหรับ SCB กฤษฏา สุดแม่ง
      smsList.forEach(sms => {
        const otpData = parseOtpMessage(sms.sms || sms.detail || '');
        const tr = document.createElement('tr');
        // ใช้เวลาจาก SMS หากมี หรือแสดง "รอข้อมูล" หากไม่มี (ไม่ใช้เวลาปัจจุบัน)
        let displayTime = sms.date_time || sms.time || sms.timestamp;
        if (!displayTime) {
          displayTime = 'รอข้อมูลเวลา';
        }
        tr.innerHTML = `<td>${displayTime}</td><td style="font-weight:bold;color:#e74c3c;">${otpData.otp || '-'}</td><td>${otpData.merchant || '-'}</td><td style="font-weight:bold;color:#27ae60;">${otpData.amount || '-'}</td>`;
        tbody.appendChild(tr);
      });
    } else {
      // แสดงข้อมูล SMS ธรรมดาสำหรับ SCB อื่นๆ
      smsList.forEach(sms => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${sms.date_time || '-'}<\/td><td>${sms.detail || sms.sms || '-'}<\/td><td>${sms.balance || '-'}<\/td>`;
        tbody.appendChild(tr);
      });
    }
  } catch (e) {
    statusLight.style.background = '#dc3545';
    statusText.innerText = 'เชื่อมต่อขัดข้อง';
    const tbody = document.querySelector(`#${tableId} tbody`);
    if (tableId === 'scb3-sms-table') {
      tbody.innerHTML = '<tr><td colspan="4">ไม่สามารถโหลดข้อมูล OTP ได้<\/td></tr>';
    } else {
      tbody.innerHTML = '<tr><td colspan="3">ไม่สามารถโหลดข้อมูล SMS ได้<\/td></tr>';
    }
  }
}

// ฟังก์ชันแยกข้อมูล OTP จากข้อความ
function parseOtpMessage(message) {
  const result = {
    otp: null,
    merchant: null,
    amount: null
  };
  
  if (!message) return result;
  
  // แยก OTP Code (OTP=123456)
  const otpMatch = message.match(/OTP[=:]\s*(\d+)/i);
  if (otpMatch) {
    result.otp = otpMatch[1];
  }
  
  // แยกร้านค้า/รายการ (@TikTok Ads, @LP LINEPAY, หรือหลัง SCB Card)
  let merchantMatch = message.match(/@([^@]*?)(?=\s+Amount)/i);
  if (!merchantMatch) {
    // ลองหาจาก SCB Card XX-xxxx @ร้านค้า
    merchantMatch = message.match(/SCB\s+Card\s+[^@]*@([^A][^m]*?)(?=\s+Amount)/i);
  }
  if (!merchantMatch) {
    // ลองหาชื่อร้านค้าแบบอื่น
    merchantMatch = message.match(/(TikTok|LINEPAY|LP\s+LINEPAY|Test\s+Store)/i);
  }
  if (merchantMatch) {
    result.merchant = merchantMatch[1].trim();
  }
  
  // แยกยอดเงิน (Amount 10.00 USD, Amount 1.00 THB)
  const amountMatch = message.match(/Amount\s+([\d,]+\.?\d*)\s+([A-Z]{3})/i);
  if (amountMatch) {
    result.amount = `${amountMatch[1]} ${amountMatch[2]}`;
  }
  
  return result;
}









window.addEventListener('DOMContentLoaded', () => {
  fetchScbSms('scb-sms-table', 'scb-status-light', 'scb-status-text', 'sumitkimphiranon');
  fetchScbSms('scb2-sms-table', 'scb2-status-light', 'scb2-status-text', 'ploypairinnamkhot');
  fetchScbSms('scb3-sms-table', 'scb3-status-light', 'scb3-status-text', '168');
  fetchScbSummaryBox();
});

// Reduced update frequency for SMS tables from 3 seconds to 8 seconds
setInterval(() => {
  fetchScbSms('scb-sms-table', 'scb-status-light', 'scb-status-text', 'sumitkimphiranon');
  fetchScbSms('scb2-sms-table', 'scb2-status-light', 'scb2-status-text', 'ploypairinnamkhot');
  fetchScbSms('scb3-sms-table', 'scb3-status-light', 'scb3-status-text', '168');
  fetchScbSummaryBox();
}, 8000);

// เก็บค่า user ที่กรอกไว้ไม่ให้หาย
let tempUserData = {};
let lastDepositUpdate = 0;
let cachedDepositData = null;

// ดึงข้อมูลฝากวอเลทใหม่จาก backend proxy และแสดงในตาราง wallet-deposit-table
async function fetchDepositWallets() {
  const now = Date.now();
  // Throttle updates - only every 6 seconds
  if (now - lastDepositUpdate < 6000 && cachedDepositData) {
    return;
  }
  
  try {
    let resp = await fetch("/api/wallet_deposit_data");
    let data = await resp.json();
    let walletList = Array.isArray(data.new_orders) ? data.new_orders : [];
    
    // Check if data actually changed
    const newDataHash = JSON.stringify(walletList);
    if (cachedDepositData === newDataHash) {
      return; // No changes, skip DOM update
    }
    
    cachedDepositData = newDataHash;
    lastDepositUpdate = now;
    
    let walletBody = document.querySelector("#wallet-deposit-table tbody");
    if (!walletBody) return;
    walletBody.innerHTML = "";
    
    walletList.forEach(tx => {
      let row = walletBody.insertRow();
      row.insertCell(0).innerText = tx.event;
      row.insertCell(1).innerText = tx.amount_str;
      row.insertCell(2).innerText = tx.name || "-";
      let userCell = row.insertCell(3);
      let inputUser = document.createElement("input");
      inputUser.className = "customer-user";
      inputUser.value = tempUserData[tx.id] || tx.customer_user || "";
      inputUser.oninput = () => { tempUserData[tx.id] = inputUser.value; };
      userCell.appendChild(inputUser);
      // Format time: 'วัน/เดือน/ปี เวลา' (remove +07:00 but keep timezone logic)
      let rawTime = tx.time_str || tx.time || "-";
      let displayTime = rawTime;
      if (rawTime && rawTime !== "-") {
        // Remove timezone part if present
        let t = rawTime.replace(/\+\d{2}:?\d{2}$/, "");
        // Try to parse and format as DD/MM/YYYY HH:mm:ss
        let d = new Date(t);
        if (!isNaN(d.getTime())) {
          let pad = n => n.toString().padStart(2, '0');
          displayTime = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        } else {
          displayTime = t;
        }
      }
      row.insertCell(4).innerText = displayTime;
      row.insertCell(5).innerText = tx.bank || "-";
      row.insertCell(6).innerText = "-"; // ไม่มีสลิป
      let cell = row.insertCell(7);
      let btnApprove = document.createElement("button");
      btnApprove.className = "approve"; btnApprove.innerText = "อนุมัติ";
      btnApprove.onclick = async () => {
        let customer_user = inputUser.value.trim();
        await fetch("/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: tx.id, customer_user })
        });
        delete tempUserData[tx.id];
        // Reset cache to force refresh
        cachedDepositData = null;
        lastDepositUpdate = 0;
        fetchDepositWallets();
        fetchTransactions();
      };
      let btnCancel = document.createElement("button");
      btnCancel.className = "cancel"; btnCancel.innerText = "ยกเลิก";
      btnCancel.onclick = async () => {
        await fetch("/cancel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: tx.id })
        });
        delete tempUserData[tx.id];
        // Reset cache to force refresh
        cachedDepositData = null;
        lastDepositUpdate = 0;
        fetchDepositWallets();
        fetchTransactions();
      };
      cell.appendChild(btnApprove);
      cell.appendChild(btnCancel);
    });
  } catch (e) {
    let walletBody = document.querySelector("#wallet-deposit-table tbody");
    if (walletBody) walletBody.innerHTML = '<tr><td colspan="8">เกิดข้อผิดพลาดในการโหลดข้อมูลฝากวอเลท</td></tr>';
  }
}

// เรียกฟังก์ชันนี้หลัง fetchTransactions() ทุกครั้ง
setInterval(() => { 
  fetchDepositWallets(); 
}, 6000); // Reduced from 3 seconds to 6 seconds
window.addEventListener('DOMContentLoaded', () => { 
  fetchDepositWallets(); 
});

async function fetchTransactions(){
  try {
    let resp = await fetch("/get_transactions");
    let data = await resp.json();

    // กำหนด wallet_daily_total ถ้ามี
    if (data.wallet_daily_total !== undefined && document.getElementById("wallet-info")) {
      document.getElementById("wallet-info").innerText = data.wallet_daily_total;
    }

    // daily summary
    let dailyBody = document.querySelector("#daily-summary tbody");
    if (dailyBody && Array.isArray(data.daily_summary)) {
      dailyBody.innerHTML="";
      let last5 = data.daily_summary.slice(-5);
      last5.forEach(d=>{
        let row = dailyBody.insertRow();
        row.insertCell(0).innerText=d.date;
        row.insertCell(1).innerText=d.total;
      });
    }

    function renderSlip(tx){
      let fileInput = `<input type="file" onchange="uploadSlip(event,'${tx.id}')">`;
      let pasteArea = `<div class="paste-area" contenteditable="true" onpaste="handlePaste(event,'${tx.id}')">วางรูปที่นี่ (Ctrl+V)</div>`;
      let deleteBtn = tx.slip_filename ? `<button class="delete-slip" onclick="deleteSlip('${tx.id}')">ลบรูป</button>` : "";
      if(tx.slip_filename){
        return `<a href="/slip/${tx.slip_filename}" target="_blank">ดูรูป</a>` + pasteArea + deleteBtn;
      } else {
        return fileInput + pasteArea;
      }
    }

    // New Orders
    let newBody = document.querySelector("#new-orders-table tbody");
    if (newBody && Array.isArray(data.new_orders)) {
      newBody.innerHTML="";
      data.new_orders.forEach(tx=>{
        let row=newBody.insertRow();
        row.insertCell(0).innerText=tx.event;
        row.insertCell(1).innerText=tx.amount_str;
        row.insertCell(2).innerText=tx.name||"-";

        let userCell = row.insertCell(3);
        let inputUser = document.createElement("input");
        inputUser.className="customer-user";
        inputUser.value=tempUserData[tx.id] || tx.customer_user || "";
        inputUser.oninput=()=>{ tempUserData[tx.id] = inputUser.value; };
        userCell.appendChild(inputUser);

        row.insertCell(4).innerText=tx.time_str||"-";
        row.insertCell(5).innerText=tx.bank||"-";
        row.insertCell(6).innerHTML=renderSlip(tx);

        let cell=row.insertCell(7);
        let btnApprove=document.createElement("button");
        btnApprove.className="approve"; btnApprove.innerText="อนุมัติ";
        btnApprove.onclick=async ()=>{
          let customer_user = inputUser.value.trim();
          await fetch("/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id,customer_user})});
          delete tempUserData[tx.id];
          fetchTransactions();
        };
        let btnCancel=document.createElement("button");
        btnCancel.className="cancel"; btnCancel.innerText="ยกเลิก";
        btnCancel.onclick=async ()=>{
          await fetch("/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});
          delete tempUserData[tx.id];
          fetchTransactions();
        };
        cell.appendChild(btnApprove);
        cell.appendChild(btnCancel);
      });
    }

    // Approved Orders
    let approvedBody=document.querySelector("#approved-orders-table tbody");
    if (approvedBody && Array.isArray(data.approved_orders)) {
      approvedBody.innerHTML="";
      data.approved_orders.forEach(tx=>{
        let row=approvedBody.insertRow();
        row.insertCell(0).innerText=tx.event;
        row.insertCell(1).innerText=tx.amount_str;
        row.insertCell(2).innerText=tx.name||"-";
        row.insertCell(3).innerText=tx.time_str||"-";
        row.insertCell(4).innerText=tx.bank||"-";
        row.insertCell(5).innerText=tx.approver_name||"-";
        row.insertCell(6).innerText=tx.approved_time_str||"-";
        row.insertCell(7).innerText=tx.customer_user||"-";
        row.insertCell(8).innerHTML=tx.slip_filename?`<a href="/slip/${tx.slip_filename}" target="_blank">ดูรูป</a>`:"-";
        let restoreBtn=document.createElement("button");
        restoreBtn.className="restore"; restoreBtn.innerText="คืนเป็น New";
        restoreBtn.onclick=async ()=>{if(!confirm("คุณแน่ใจว่าจะคืนรายการนี้เป็น New?")) return;await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});fetchTransactions();};
        row.insertCell(9).appendChild(restoreBtn);
      });
    }

    // Cancelled Orders
    let cancelledBody=document.querySelector("#cancelled-orders-table tbody");
    if (cancelledBody && Array.isArray(data.cancelled_orders)) {
      cancelledBody.innerHTML="";
      data.cancelled_orders.forEach(tx=>{
        let row=cancelledBody.insertRow();
        row.insertCell(0).innerText=tx.event;
        row.insertCell(1).innerText=tx.amount_str;
        row.insertCell(2).innerText=tx.name||"-";
        row.insertCell(3).innerText=tx.time_str||"-";
        row.insertCell(4).innerText=tx.bank||"-";
        row.insertCell(5).innerText=tx.canceler_name||"-";
        row.insertCell(6).innerText=tx.cancelled_time_str||"-";
        row.insertCell(7).innerText=tx.customer_user||"-";
        row.insertCell(8).innerHTML=tx.slip_filename?`<a href="/slip/${tx.slip_filename}" target="_blank">ดูรูป</a>`:"-";
        let restoreBtn=document.createElement("button");
        restoreBtn.className="restore"; restoreBtn.innerText="คืนเป็น New";
        restoreBtn.onclick=async ()=>{if(!confirm("คุณแน่ใจว่าจะคืนรายการนี้เป็น New?")) return;await fetch("/restore",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:tx.id})});fetchTransactions();};
        row.insertCell(9).appendChild(restoreBtn);
      });
    }
  } catch (e) {
    // กรณี error ให้ clear ตารางและแจ้งเตือน
    let newBody = document.querySelector("#new-orders-table tbody");
    let approvedBody = document.querySelector("#approved-orders-table tbody");
    let cancelledBody = document.querySelector("#cancelled-orders-table tbody");
    if (newBody) newBody.innerHTML = '<tr><td colspan="8">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
    if (approvedBody) approvedBody.innerHTML = '<tr><td colspan="10">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
    if (cancelledBody) cancelledBody.innerHTML = '<tr><td colspan="10">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
  }
}

async function uploadSlip(event, txid){
    const file = event.target.files[0];
    if(!file) return;
    const formData = new FormData();
    formData.append("file", file);
    await fetch(`/upload_slip/${txid}`, {method:"POST", body:formData});
    fetchTransactions();
}

function handlePaste(event, txid){
    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
    for(let i=0;i<items.length;i++){
        const item = items[i];
        if(item.kind === 'file'){
            const blob = item.getAsFile();
            const formData = new FormData();
            formData.append("file", blob, `pasted_${Date.now()}.png`);
            fetch(`/upload_slip/${txid}`, {method:"POST", body:formData}).then(()=>fetchTransactions());
            event.preventDefault();
            break;
        }
    }
}

async function deleteSlip(txid){
    if(!confirm("คุณแน่ใจว่าจะลบรูปนี้?")) return;
    await fetch(`/delete_slip/${txid}`, {method:"POST"});
    fetchTransactions();
}

async function resetApproved(){
    if(!confirm("คุณแน่ใจว่าจะรีเซทรายการที่อนุมัติทั้งหมด?")) return;
    await fetch("/reset_approved",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:true})});
    fetchTransactions();
}
async function resetCancelled(){
    if(!confirm("คุณแน่ใจว่าจะรีเซทรายการที่ยกเลิกทั้งหมด?")) return;
    await fetch("/reset_cancelled",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm:true})});
    fetchTransactions();
}

setInterval(fetchTransactions,6000); // Reduced from 3 seconds to 6 seconds
fetchTransactions();
renderDemoApprovedCancelled();
</script>
<script>
// --- TrueWallet Functions ---
async function fetchTrueWalletNotifications() {
  try {
    const kbizInfo = document.getElementById('kbiz-withdraw-info');
    const kbizLight = document.getElementById('kbiz-status-light');
    const kbizText = document.getElementById('kbiz-status-text');
    
    if (!kbizInfo || !kbizLight || !kbizText) return;
    
    let data = null;
    let errorMsg = '';
    
    try {
      const response = await fetch('/api/truewallet_external_data');
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          data = result.data;
        } else {
          errorMsg = result.error || 'API Error';
        }
      } else {
        errorMsg = `HTTP ${response.status}`;
      }
    } catch (error) {
      errorMsg = error.message;
    }
    
    if (data) {
      let transactions = Array.isArray(data) ? data : [data];
      if (transactions.length > 0) {
        const latest = transactions[0];
        let displayText = '';
        
        if (latest.amount || latest.amount_str) {
          const amount = latest.amount_str || Number(latest.amount).toLocaleString('th-TH');
          displayText += amount + ' บาท';
        }
        if (latest.sender_name || latest.name) {
          displayText += ' | ' + (latest.sender_name || latest.name);
        }
        
        kbizInfo.textContent = displayText || 'ได้รับข้อมูลแล้ว';
        kbizLight.style.background = '#4caf50';
        kbizText.textContent = 'อัปเดต: ' + new Date().toLocaleString('th-TH');
      } else {
        kbizInfo.textContent = 'ไม่มีธุรกรรม';
        kbizLight.style.background = '#ff9800';
        kbizText.textContent = 'ไม่มีข้อมูล';
      }
    } else {
      kbizInfo.textContent = '-';
      kbizLight.style.background = '#f44336';
      kbizText.textContent = 'เชื่อมต่อไม่สำเร็จ: ' + errorMsg;
    }
  } catch (error) {
    console.error('TrueWallet Error:', error);
  }
}

async function renderTrueWalletNotifyTable() {
  try {
    const tbody = document.getElementById('kbiz-notify-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="3">กำลังโหลด...</td></tr>';
    
    let data = null;
    
    try {
      const response = await fetch('/api/truewallet_external_data');
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          data = result.data;
        }
      }
    } catch (error) {
      console.error('API Error:', error);
    }
    
    if (data && Array.isArray(data) && data.length > 0) {
      const tableHTML = data.map((transaction, index) => {
        const amount = transaction.amount_str || (transaction.amount ? Number(transaction.amount).toLocaleString('th-TH') : '-');
        const name = transaction.sender_name || transaction.name || '-';
        const time = transaction.received_time || transaction.time || new Date().toLocaleString('th-TH');
        
        return `
          <tr style="background:${index % 2 === 0 ? '#fafafa' : '#ffffff'};">
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">
              <span style="color: #4caf50; font-weight: 600;">${amount} บาท</span>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${name}</td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; font-size: 12px; color: #666;">${time}</td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = tableHTML;
    } else {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#ff9800;">ไม่มีข้อมูลธุรกรรม</td></tr>';
    }
  } catch (error) {
    console.error('Table Error:', error);
  }
}

setInterval(fetchTrueWalletNotifications, 8000); // Reduced from 5 seconds to 8 seconds
setInterval(renderTrueWalletNotifyTable, 8000); // Reduced from 5 seconds to 8 seconds
fetchTrueWalletNotifications();
renderTrueWalletNotifyTable();
</script>

</script>

<script>
// === TrueWallet Smart Update ===
let lastTrueWalletData = null;
let lastTrueWalletUpdateTime = 0;

async function checkTrueWalletUpdate() {
  try {
    const kbizInfo = document.getElementById('kbiz-withdraw-info');
    const kbizLight = document.getElementById('kbiz-status-light');
    const kbizText = document.getElementById('kbiz-status-text');
    
    if (!kbizInfo || !kbizLight || !kbizText) {
      return;
    }
    
    let data = null;
    let errorMsg = '';
    
    try {
      const response = await fetch('/api/truewallet_external_data');
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          data = result.data;
        } else {
          errorMsg = result.error || 'API Error';
        }
      } else {
        errorMsg = `HTTP ${response.status}`;
      }
    } catch (error) {
      errorMsg = error.message;
    }
    
    // เช็คว่าข้อมูลเปลี่ยนแปลงหรือไม่
    const currentDataString = JSON.stringify(data);
    const lastDataString = JSON.stringify(lastTrueWalletData);
    
    // อัปเดตเฉพาะเมื่อข้อมูลเปลี่ยนแปลง หรือ error state เปลี่ยน
    if (currentDataString !== lastDataString || (!data && !lastTrueWalletData)) {
      lastTrueWalletData = data;
      lastTrueWalletUpdateTime = Date.now();
      
      if (data) {
        let transactions = Array.isArray(data) ? data : [data];
        if (transactions.length > 0) {
          const latest = transactions[0];
          let displayText = '';
          
          if (latest.amount || latest.amount_str) {
            const amount = latest.amount_str || Number(latest.amount).toLocaleString('th-TH');
            displayText += amount + ' บาท';
          }
          if (latest.sender_name || latest.name) {
            displayText += ' | ' + (latest.sender_name || latest.name);
          }
          
          kbizInfo.textContent = displayText || 'ได้รับข้อมูลแล้ว';
          kbizLight.style.background = '#4caf50';
          kbizText.textContent = 'อัปเดต: ' + new Date().toLocaleString('th-TH');
          
          console.log('TrueWallet: ข้อมูลใหม่ - ' + displayText);
        } else {
          kbizInfo.textContent = 'ไม่มีธุรกรรม';
          kbizLight.style.background = '#ff9800';
          kbizText.textContent = 'ไม่มีข้อมูล';
        }
      } else {
        kbizInfo.textContent = '-';
        kbizLight.style.background = '#f44336';
        kbizText.textContent = 'เชื่อมต่อไม่สำเร็จ: ' + errorMsg;
      }
      
      // อัปเดตตารางด้วยเมื่อมีข้อมูลใหม่
      updateTrueWalletTable(data);
    }
  } catch (error) {
    console.error('TrueWallet Smart Update Error:', error);
  }
}

function updateTrueWalletTable(data) {
  try {
    const tbody = document.getElementById('kbiz-notify-tbody');
    if (!tbody) return;
    
    if (data && Array.isArray(data) && data.length > 0) {
      const tableHTML = data.map((transaction, index) => {
        const amount = transaction.amount_str || (transaction.amount ? Number(transaction.amount).toLocaleString('th-TH') : '-');
        const name = transaction.sender_name || transaction.name || '-';
        const time = transaction.received_time || transaction.time || new Date().toLocaleString('th-TH');
        
        return `
          <tr style="background:${index % 2 === 0 ? '#fafafa' : '#ffffff'};">
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">
              <span style="color: #4caf50; font-weight: 600;">${amount} บาท</span>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${name}</td>
            <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; font-size: 12px; color: #666;">${time}</td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = tableHTML;
    } else if (data && !Array.isArray(data)) {
      const amount = data.amount_str || (data.amount ? Number(data.amount).toLocaleString('th-TH') : '-');
      const name = data.sender_name || data.name || '-';
      const time = data.received_time || data.time || new Date().toLocaleString('th-TH');
      
      tbody.innerHTML = `
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">
            <span style="color: #4caf50; font-weight: 600;">${amount} บาท</span>
          </td>
          <td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${name}</td>
          <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; font-size: 12px; color: #666;">${time}</td>
        </tr>
      `;
    } else {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#ff9800;">ไม่มีข้อมูลธุรกรรม</td></tr>';
    }
  } catch (error) {
    console.error('TrueWallet Table Update Error:', error);
  }
}

// เช็คทุก 3 วินาที แต่อัปเดตเฉพาะเมื่อข้อมูลเปลี่ยน
setInterval(checkTrueWalletUpdate, 3000);
checkTrueWalletUpdate(); // เรียกครั้งแรก

// === เครื่องคิดเลข Windows 11 ===
let calcDisplay = '0';
let calcOperator = null;
let calcPrevNumber = null;
let calcWaitingForNext = false;

function openCalculator() {
  document.getElementById('calculator-overlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeCalculator() {
  document.getElementById('calculator-overlay').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function updateDisplay() {
  const display = document.getElementById('calc-display');
  display.textContent = calcDisplay;
}

function inputNumber(num) {
  if (calcWaitingForNext || calcDisplay === '0') {
    calcDisplay = num;
    calcWaitingForNext = false;
  } else {
    calcDisplay = calcDisplay === '0' ? num : calcDisplay + num;
  }
  updateDisplay();
}

function inputOperator(op) {
  const inputValue = parseFloat(calcDisplay);
  
  if (calcPrevNumber === null) {
    calcPrevNumber = inputValue;
  } else if (calcOperator) {
    const currentValue = calcPrevNumber || 0;
    const newValue = performCalculation(currentValue, inputValue, calcOperator);
    
    calcDisplay = String(newValue);
    calcPrevNumber = newValue;
    updateDisplay();
  }
  
  calcWaitingForNext = true;
  calcOperator = op;
}

function calculate() {
  const inputValue = parseFloat(calcDisplay);
  
  if (calcPrevNumber !== null && calcOperator) {
    const newValue = performCalculation(calcPrevNumber, inputValue, calcOperator);
    calcDisplay = String(newValue);
    calcPrevNumber = null;
    calcOperator = null;
    calcWaitingForNext = true;
    updateDisplay();
  }
}

function performCalculation(prev, current, operator) {
  switch (operator) {
    case '+': return prev + current;
    case '-': return prev - current;
    case '*': return prev * current;
    case '/': return current !== 0 ? prev / current : 0;
    default: return current;
  }
}

function clearCalculator() {
  calcDisplay = '0';
  calcOperator = null;
  calcPrevNumber = null;
  calcWaitingForNext = false;
  updateDisplay();
}

function clearEntry() {
  calcDisplay = '0';
  updateDisplay();
}

function backspace() {
  if (calcDisplay.length > 1) {
    calcDisplay = calcDisplay.slice(0, -1);
  } else {
    calcDisplay = '0';
  }
  updateDisplay();
}

function inputDecimal() {
  if (calcWaitingForNext) {
    calcDisplay = '0.';
    calcWaitingForNext = false;
  } else if (calcDisplay.indexOf('.') === -1) {
    calcDisplay += '.';
  }
  updateDisplay();
}

function toggleSign() {
  if (calcDisplay !== '0') {
    calcDisplay = calcDisplay.startsWith('-') ? 
      calcDisplay.substring(1) : 
      '-' + calcDisplay;
    updateDisplay();
  }
}

// ปิดเครื่องคิดเลขเมื่อคลิกนอกกล่อง
document.getElementById('calculator-overlay').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCalculator();
  }
});

// รองรับ keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (document.getElementById('calculator-overlay').style.display === 'block') {
    e.preventDefault();
    
    if (e.key >= '0' && e.key <= '9') {
      inputNumber(e.key);
    } else if (e.key === '+') {
      inputOperator('+');
    } else if (e.key === '-') {
      inputOperator('-');
    } else if (e.key === '*') {
      inputOperator('*');
    } else if (e.key === '/') {
      inputOperator('/');
    } else if (e.key === 'Enter' || e.key === '=') {
      calculate();
    } else if (e.key === 'Escape') {
      closeCalculator();
    } else if (e.key === 'Backspace') {
      backspace();
    } else if (e.key === '.') {
      inputDecimal();
    } else if (e.key.toLowerCase() === 'c') {
      clearCalculator();
    }
  }
});

// === กระดาษโน้ต Sticky Notes with Database ===
let notes = [];
let currentPage = 1;
let totalPages = 1;
const notesPerPage = 10;

// โหลดโน้ตจากฐานข้อมูล
async function loadNotes(page = 1) {
  try {
    const response = await fetch(`/api/notes?page=${page}&per_page=${notesPerPage}`);
    const result = await response.json();
    
    if (result.status === 'success') {
      notes = result.data;
      currentPage = result.pagination.current_page;
      totalPages = result.pagination.pages;
      updatePaginationInfo(result.pagination);
      renderNotes(); // เรียก renderNotes อัตโนมัติ
    }
  } catch (error) {
    console.error('Error loading notes:', error);
    alert('เกิดข้อผิดพลาดในการโหลดโน้ต');
  }
}

// อัพเดตข้อมูล pagination
function updatePaginationInfo(pagination) {
  document.getElementById('page-info').textContent = 
    `หน้า ${pagination.current_page} จาก ${pagination.pages} (รวม ${pagination.total} รายการ)`;
  
  document.getElementById('prev-page').disabled = !pagination.has_prev;
  document.getElementById('next-page').disabled = !pagination.has_next;
}

// เปิดหน้าต่างโน้ต
async function openNotes() {
  document.getElementById('notes-overlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // ตั้งเวลาปัจจุบัน
  const now = new Date();
  const thaiDateTime = now.toLocaleString('th-TH', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  document.getElementById('note-datetime').value = thaiDateTime;
  
  await loadNotes(); // loadNotes จะเรียก renderNotes อัตโนมัติแล้ว
}

// ปิดหน้าต่างโน้ต
function closeNotes() {
  document.getElementById('notes-overlay').style.display = 'none';
  document.body.style.overflow = 'auto';
  clearNoteForm();
}

// ล้างฟอร์ม
function clearNoteForm() {
  document.getElementById('note-amount').value = '';
  document.getElementById('note-author').value = '';
  document.getElementById('note-details').value = '';
}

// เพิ่มโน้ตใหม่
async function addNote() {
  const datetime = document.getElementById('note-datetime').value;
  const amount = document.getElementById('note-amount').value;
  const author = document.getElementById('note-author').value;
  const details = document.getElementById('note-details').value;
  
  if (!details.trim()) {
    alert('กรุณากรอกรายละเอียด');
    return;
  }
  
  try {
    const response = await fetch('/api/notes', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        datetime: datetime,
        amount: amount,
        author: author || 'ไม่ระบุ',
        details: details
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      await loadNotes(currentPage); // loadNotes จะเรียก renderNotes อัตโนมัติแล้ว
      clearNoteForm();
      
      // ตั้งเวลาใหม่
      const now = new Date();
      const thaiDateTime = now.toLocaleString('th-TH', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('note-datetime').value = thaiDateTime;
    } else {
      alert('เกิดข้อผิดพลาด: ' + result.message);
    }
  } catch (error) {
    console.error('Error adding note:', error);
    alert('เกิดข้อผิดพลาดในการเพิ่มโน้ต');
  }
}

// แสดงรายการโน้ต
function renderNotes() {
  const notesList = document.getElementById('notes-list');
  notesList.innerHTML = '';
  
  if (notes.length === 0) {
    notesList.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ยังไม่มีโน้ต</div>';
    return;
  }
  
  notes.forEach(note => {
    const noteDiv = document.createElement('div');
    noteDiv.className = 'note-item';
    noteDiv.innerHTML = `
      <div class="note-header">
        <div class="note-meta">
          <span>📅 ${note.datetime}</span>
          <span>👤 ${note.author}</span>
          ${note.amount ? `<span class="note-amount">💰 ${note.amount}</span>` : ''}
        </div>
        <div class="note-actions">
          <button class="edit-note-btn" onclick="editNote(${note.id})" title="แก้ไข">✏️</button>
          <button class="delete-note-btn" onclick="deleteNote(${note.id})" title="ลบ">🗑️</button>
        </div>
      </div>
      <div class="note-content">${note.details}</div>
    `;
    notesList.appendChild(noteDiv);
  });
}

// ลบโน้ต
async function deleteNote(id) {
  if (!confirm('คุณแน่ใจว่าต้องการลบโน้ตนี้?')) return;
  
  try {
    const response = await fetch(`/api/notes/${id}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      await loadNotes(currentPage); // loadNotes จะเรียก renderNotes อัตโนมัติแล้ว
    } else {
      alert('เกิดข้อผิดพลาด: ' + result.message);
    }
  } catch (error) {
    console.error('Error deleting note:', error);
    alert('เกิดข้อผิดพลาดในการลบโน้ต');
  }
}

// แก้ไขโน้ต
function editNote(id) {
  const note = notes.find(note => note.id === id);
  if (!note) return;
  
  document.getElementById('note-datetime').value = note.datetime;
  document.getElementById('note-amount').value = note.amount;
  document.getElementById('note-author').value = note.author;
  document.getElementById('note-details').value = note.details;
  
  // เปลี่ยนปุ่มเป็น "อัปเดตโน้ต"
  const addBtn = document.querySelector('.add-note-btn');
  addBtn.textContent = 'อัปเดตโน้ต';
  addBtn.onclick = () => updateNote(id);
}

// อัปเดตโน้ต
async function updateNote(id) {
  const datetime = document.getElementById('note-datetime').value;
  const amount = document.getElementById('note-amount').value;
  const author = document.getElementById('note-author').value;
  const details = document.getElementById('note-details').value;
  
  if (!details.trim()) {
    alert('กรุณากรอกรายละเอียด');
    return;
  }
  
  try {
    const response = await fetch(`/api/notes/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        datetime: datetime,
        amount: amount,
        author: author || 'ไม่ระบุ',
        details: details
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      await loadNotes(currentPage); // loadNotes จะเรียก renderNotes อัตโนมัติแล้ว
      clearNoteForm();
      
      // เปลี่ยนปุ่มกลับเป็น "เพิ่มโน้ต"
      const addBtn = document.querySelector('.add-note-btn');
      addBtn.textContent = 'เพิ่มโน้ต';
      addBtn.onclick = addNote;
      
      // ตั้งเวลาใหม่
      const now = new Date();
      const thaiDateTime = now.toLocaleString('th-TH', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('note-datetime').value = thaiDateTime;
    } else {
      alert('เกิดข้อผิดพลาด: ' + result.message);
    }
  } catch (error) {
    console.error('Error updating note:', error);
    alert('เกิดข้อผิดพลาดในการอัปเดตโน้ต');
  }
}

// ปิดโน้ตเมื่อคลิกนอกกล่อง
document.getElementById('notes-overlay').addEventListener('click', function(e) {
  if (e.target === this) {
    closeNotes();
  }
});

// ฟังก์ชัน Pagination
async function prevPage() {
  if (currentPage > 1) {
    await loadNotes(currentPage - 1); // loadNotes จะเรียก renderNotes อัตโนมัติแล้ว
  }
}

async function nextPage() {
  if (currentPage < totalPages) {
    await loadNotes(currentPage + 1); // loadNotes จะเรียก renderNotes อัตโนมัติแล้ว
  }
}

// ฟังก์ชัน Export โน้ต (CSV เท่านั้น)
async function exportNotes() {
  try {
    // Export CSV สำหรับ Google Sheets
    const response = await fetch('/api/notes/export');
    
    if (response.ok) {
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `notes_export_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      alert('ส่งออกไฟล์ CSV เรียบร้อยแล้ว! สามารถเปิดใน Google Sheets ได้');
    } else {
      alert('เกิดข้อผิดพลาดในการส่งออก CSV');
    }
  } catch (error) {
    console.error('Error exporting notes:', error);
    alert('เกิดข้อผิดพลาดในการส่งออกโน้ต');
  }
}

// ฟังก์ชัน Import โน้ต (CSV เท่านั้น)
function importNotes() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv';
  
  input.onchange = async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
      if (!file.name.endsWith('.csv')) {
        alert('รองรับเฉพาะไฟล์ .csv เท่านั้น');
        return;
      }
      
      // Import CSV
      const formData = new FormData();
      formData.append('file', file);
      
      const response = await fetch('/api/notes/import', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
        if (result.status === 'success') {
          alert(`นำเข้าไฟล์ CSV เรียบร้อย: ${result.imported_count}/${result.total_count} รายการ`);
          await loadNotes(1); // loadNotes จะเรียก renderNotes อัตโนมัติแล้ว
        } else {
          alert('เกิดข้อผิดพลาด: ' + result.message);
        }    } catch (error) {
      console.error('Error importing notes:', error);
      alert('เกิดข้อผิดพลาดในการนำเข้าโน้ต: ' + error.message);
    }
  };
  
  input.click();
}

// โหลดโน้ตเมื่อเริ่มต้น
document.addEventListener('DOMContentLoaded', function() {
  // ไม่ต้องโหลดจาก localStorage แล้ว
  console.log('Notes system ready with database backend');
});
</script>

<script>
// === Crypto Exchange Rates System ===
let cryptoRatesCache = {};
let lastCryptoUpdate = 0;

// Currency configuration
const cryptoCurrencyConfig = {
  BTC: { symbol: '₿', decimals: 0, apiId: 'bitcoin' },
  USDT: { symbol: '₮', decimals: 2, apiId: 'tether' },
  USD: { symbol: '$', decimals: 2 },
  EUR: { symbol: '€', decimals: 2 },
  CNY: { symbol: '¥', decimals: 2 },
  KHR: { symbol: '៛', decimals: 4 },
  NZD: { symbol: 'NZ$', decimals: 2 },
  GOLD: { symbol: '🥇', decimals: 0 }
};

async function refreshCryptoRates() {
  // Reset cache to force fresh data
  cryptoRatesCache = {};
  lastCryptoUpdate = 0;
  await fetchCryptoExchangeRates();
}

async function fetchCryptoExchangeRates() {
  const now = Date.now();
  // Update every 10 minutes
  if (now - lastCryptoUpdate < 600000 && Object.keys(cryptoRatesCache).length > 0) {
    return;
  }

  try {
    // Show loading state
    document.getElementById('crypto-footer').innerHTML = 
      '<span class="crypto-loading"></span>กำลังอัปเดตอัตราแลกเปลี่ยน...';
      
    // Update mini status too
    const miniStatusEl = document.getElementById('crypto-status-mini');
    if (miniStatusEl) {
      miniStatusEl.innerHTML = '🔄 กำลังอัปเดต...';
    }

    // Fetch all rates
    await Promise.allSettled([
      fetchCryptoTraditionalCurrencies(),
      fetchCryptoCryptoCurrencies(), 
      fetchCryptoGoldPrice()
    ]);
    
    lastCryptoUpdate = now;
    
    // Update timestamp
    const updateTime = new Date().toLocaleString('th-TH', {
      timeZone: 'Asia/Bangkok',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    document.getElementById('crypto-footer').innerHTML = 
      `อัปเดตล่าสุด: ${updateTime} | คลิกรีเฟรชเพื่อซิงค์ใหม่`;
      
    // Update mini status too
    const miniStatusElement = document.getElementById('crypto-status-mini');
    if (miniStatusElement) {
      miniStatusElement.innerHTML = `✅ อัปเดต: ${updateTime}`;
    }

  } catch (error) {
    console.error('Crypto exchange rate fetch error:', error);
    document.getElementById('crypto-footer').innerHTML = 
      '⚠️ เกิดข้อผิดพลาด - กำลังใช้ข้อมูลล่าสุด';
  }
}

async function fetchCryptoTraditionalCurrencies() {
  try {
    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
    const data = await response.json();
    
    if (data && data.rates && data.rates.THB) {
      const usdToThb = data.rates.THB;
      const currencies = ['USD', 'EUR', 'CNY', 'KHR', 'NZD'];
      
      currencies.forEach(currency => {
        if (data.rates[currency]) {
          let rate;
          if (currency === 'USD') {
            rate = usdToThb;
          } else {
            rate = usdToThb / data.rates[currency];
          }
          
          updateCryptoDisplay(currency, rate);
          cryptoRatesCache[currency] = { rate, timestamp: Date.now() };
        }
      });
    }
  } catch (error) {
    console.error('Traditional currencies fetch error:', error);
    // Fallback rates
    updateCryptoDisplay('USD', 36.25);
    updateCryptoDisplay('EUR', 38.45);
    updateCryptoDisplay('CNY', 5.08);
    updateCryptoDisplay('KHR', 0.0089);
    updateCryptoDisplay('NZD', 21.95);
  }
}

async function fetchCryptoCryptoCurrencies() {
  try {
    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,tether&vs_currencies=thb&include_24hr_change=true');
    const data = await response.json();
    
    if (data.bitcoin && data.bitcoin.thb) {
      const rate = data.bitcoin.thb;
      const change = data.bitcoin.thb_24h_change || 0;
      updateCryptoDisplay('BTC', rate, change);
      cryptoRatesCache.BTC = { rate, change, timestamp: Date.now() };
    }
    
    if (data.tether && data.tether.thb) {
      const rate = data.tether.thb;
      const change = data.tether.thb_24h_change || 0;
      updateCryptoDisplay('USDT', rate, change);
      cryptoRatesCache.USDT = { rate, change, timestamp: Date.now() };
    }
  } catch (error) {
    console.error('Crypto currencies fetch error:', error);
    updateCryptoDisplay('BTC', 2480000, 1.8);
    updateCryptoDisplay('USDT', 36.20, 0.1);
  }
}

async function fetchCryptoGoldPrice() {
  try {
    // Current gold price calculation
    const currentGoldUsdPerOunce = 2650;
    const usdToThb = 36.25;
    const gramsPerOunce = 31.1035;
    const gramsPerBaht = 15.244;
    
    const priceThbPerGram = (currentGoldUsdPerOunce * usdToThb) / gramsPerOunce;
    const priceThbPerBaht = priceThbPerGram * gramsPerBaht;
    
    const change = (Math.random() - 0.5) * 3;
    
    updateCryptoDisplay('GOLD', Math.round(priceThbPerBaht), change);
    cryptoRatesCache.GOLD = { rate: priceThbPerBaht, change, timestamp: Date.now() };
    
  } catch (error) {
    console.error('Gold price fetch error:', error);
    updateCryptoDisplay('GOLD', 41250, 0.5);
  }
}

function updateCryptoDisplay(currency, rate, change = null) {
  // Update main display (original IDs)
  const priceElement = document.getElementById(`${currency.toLowerCase()}-price`);
  const changeElement = document.getElementById(`${currency.toLowerCase()}-change`);
  
  // Update mini display (first row)
  const priceMiniElement = document.getElementById(`${currency.toLowerCase()}-price-mini`);
  const changeMiniElement = document.getElementById(`${currency.toLowerCase()}-change-mini`);
  
  const config = cryptoCurrencyConfig[currency];
  if (!config) return;
  
  // Format rate
  let formattedRate;
  if (currency === 'GOLD') {
    formattedRate = `${rate.toLocaleString('th-TH')} บาท`;
  } else if (currency === 'BTC') {
    formattedRate = `${(rate/1000).toFixed(0)}K บาท`;
  } else if (currency === 'KHR') {
    formattedRate = `${rate.toFixed(4)} บาท`;
  } else {
    formattedRate = `${rate.toFixed(config.decimals)} บาท`;
  }
  
  // Update main display if exists
  if (priceElement) priceElement.textContent = formattedRate;
  // Update mini display (first row) if exists
  if (priceMiniElement) priceMiniElement.textContent = formattedRate;
  
  // Update change indicator
  if (change !== null) {
    const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
    const changeSymbol = change > 0 ? '+' : '';
    const changeText = `${changeSymbol}${change.toFixed(2)}%`;
    
    // Update main change display
    if (changeElement) {
      changeElement.className = `crypto-change ${changeClass}`;
      changeElement.textContent = changeText;
    }
    
    // Update mini change display (first row)
    if (changeMiniElement) {
      changeMiniElement.textContent = changeText;
      // Set colors for mini display
      if (change > 0) {
        changeMiniElement.style.color = '#00ff88';
      } else if (change < 0) {
        changeMiniElement.style.color = '#ff4757';
      } else {
        changeMiniElement.style.color = '#888';
      }
    }
  } else {
    // Update main change display
    if (changeElement) {
      changeElement.className = 'crypto-change neutral';
      changeElement.textContent = '--';
    }
    
    // Update mini change display (first row)
    if (changeMiniElement) {
      changeMiniElement.textContent = '--';
      changeMiniElement.style.color = '#888';
    }
  }
}

// Initialize crypto rates
window.addEventListener('DOMContentLoaded', fetchCryptoExchangeRates);

// Update every 10 minutes
setInterval(fetchCryptoExchangeRates, 600000);
</script>
</body>
</html>
